@model IEnumerable<InventarioWEB.Models.Producto>

@{
    ViewData["Title"] = "Productos - InventarioWEB";
    Layout = "_Layout";
}

<div class="container mt-4">
    <h2 class="text-center mb-4 text-primary fw-bold">
        📋 Lista General de Productos
    </h2>

    <!-- ==================================================
         Filtro de estado + botón crear
         * Ajustado ligeramente y documentado
    =================================================== -->
    <div class="mb-4 d-flex justify-content-end align-items-center gap-2">

        <!-- Filtro por estado (Activo / Inactivo / Todos) -->
        <form asp-action="Index" method="get" class="d-inline-flex">

            @Html.DropDownList(
                         "estado",
                         (SelectList)ViewBag.EstadosFiltro,
                         new { @class = "form-select me-2", onchange = "this.form.submit()" }
                     )

            <button class="btn btn-primary">
                <i class="bi bi-funnel"></i> Filtrar
            </button>
        </form>

        <!-- Botón para crear nuevo producto -->
        <a asp-controller="Productos" asp-action="Crear" class="btn btn-success ms-2 shadow-sm">
            <i class="bi bi-plus-circle"></i> Crear Nuevo Producto
        </a>

    </div>


    <!-- ==================================================
         Tabla de productos
    =================================================== -->
    @if (Model != null && Model.Any())
    {
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle text-center shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Referencia</th>
                            <th>Talla</th>
                            <th>Género</th>
                            <th>Tela</th>
                            <th>Color</th>
                            <th>Precio</th>
                            <th>IVA</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var p in Model)
                    {
                        // ==================================================
                        // Colores visuales según estado y stock
                        // ==================================================
                        string claseFila = !p.Activo ? "table-secondary" :
                                          (p.Stock == 0 ? "table-danger" :
                                          (p.Stock > 0 && p.Stock < 5 ? "table-warning" : ""));

                            <tr class="@claseFila">
                                <td>@p.ID_Producto</td>
                                <td>@p.Nombre</td>
                                <td>@p.Referencia?.DescripReferencia ?? "—"</td>
                                <td>@p.Talla?.DescripTalla ?? "—"</td>
                                <td>@(p.Referencia?.Genero?.DescripGenero ?? "—")</td>
                                <td>@p.Tela?.DescripTela ?? "—"</td>
                                <td>@(p.Color?.Nombre ?? "Sin color")</td>
                                <td>@p.Precio.ToString("C")</td>
                                <td>@($"{p.IVA_Porcentaje}%")</td>
                                <td>@p.Stock</td>

                                <td>
                                @if (p.Activo)
                                {
                                            <span class="badge bg-success">Activo</span>
                                }
                                else
                                {
                                            <span class="badge bg-secondary">Inactivo</span>
                                }
                                </td>

                                <td>

                                    <!-- Botón de edición (siempre visible) -->
                                    <a asp-controller="Productos"
                                       asp-action="Editar"
                                       asp-route-id="@p.ID_Producto"
                                       class="btn btn-sm btn-warning me-1">
                                        <i class="bi bi-pencil-square"></i> Editar
                                    </a>

                                    <!-- ==================================================
                                         ACCIONES SEGÚN ESTADO
                                         * Si está activo → Mostrar "Desactivar"
                                         * Si está inactivo → Mostrar "Restaurar"
                                    =================================================== -->
                                @if (p.Activo)
                                {
                                            <!-- Eliminación lógica -->
                                            <form asp-controller="Productos"
                                                  asp-action="EliminarLogico"
                                                  method="post"
                                                  asp-route-id="@p.ID_Producto"
                                                  style="display:inline;"
                                                  onsubmit="return confirm('¿Seguro que deseas desactivar este producto?');">

                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="bi bi-eye-slash"></i> Desactivar
                                                </button>
                                            </form>
                                }
                                else
                                {
                                            <!-- Restaurar producto -->
                                            <form asp-controller="Productos"
                                                  asp-action="Restaurar"
                                                  method="post"
                                                  asp-route-id="@p.ID_Producto"
                                                  style="display:inline;"
                                                  onsubmit="return confirm('¿Deseas restaurar este producto?');">

                                                <button type="submit" class="btn btn-sm btn-success">
                                                    <i class="bi bi-check-circle"></i> Restaurar
                                                </button>
                                            </form>
                                }

                                </td>
                            </tr>
                    }
                    </tbody>
                </table>
            </div>
    }
    else
    {
            <!-- Cuando no hay registros -->
            <div class="alert alert-info text-center mt-4 shadow-sm">
                <i class="bi bi-info-circle"></i> No hay productos registrados actualmente.
            </div>
    }
</div>
